# 相机权限问题修复说明

## 问题描述
体验版和正式版出现错误：
```
相机初始化失败 | 错误信息：insertXWebCamera:fail appid privacy api banned
```

## 问题原因
微信小程序从2023年9月15日起强制要求：
1. 使用敏感权限（相机、位置、录音等）的小程序必须配置**用户隐私保护指引**
2. 必须在代码中添加**隐私弹窗**，用户同意后才能调用相关API
3. 开发工具和真机调试不受限制，但体验版和正式版会被拦截

## 已完成的代码修改

### 1. 创建隐私弹窗组件
**位置**: `miniprogram/components/privacy-popup/`

包含以下文件：
- `privacy-popup.wxml` - 弹窗界面
- `privacy-popup.wxss` - 弹窗样式
- `privacy-popup.js` - 弹窗逻辑
- `privacy-popup.json` - 组件配置

**功能**：
- 自动检测是否需要显示隐私协议
- 提供"同意"和"拒绝"按钮
- 支持打开微信官方隐私协议
- 拒绝后自动返回上一页

### 2. 更新 app.js
**位置**: `miniprogram/app.js`

**新增功能**：
- 小程序启动时检查隐私协议状态
- 使用 `wx.getPrivacySetting()` API

### 3. 更新相机页面
**位置**: `miniprogram/pages/camera/`

**修改内容**：
- `index.wxml`: 添加隐私弹窗组件
- `index.json`: 注册隐私弹窗组件
- `index.js`: 添加隐私协议拒绝处理方法，延长权限检查时间

## 必须完成的后续步骤

### ⚠️ 重要：在微信公众平台配置隐私协议

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用管理员账号登录

2. **配置用户隐私保护指引**
   - 进入：设置 → 基本设置 → 服务内容声明
   - 或：设置 → 隐私设置 → 用户隐私保护指引
   
3. **填写隐私保护指引内容**
   
   **建议内容模板**：
   ```
   【用户隐私保护指引】
   
   欢迎使用AI拍姿助手！我们非常重视您的隐私保护和个人信息安全。
   
   一、我们收集的信息
   1. 相机权限：用于拍照和录制视频功能
   2. 相册权限：用于保存您拍摄的照片和视频
   3. 录音权限：用于实况拍摄功能
   
   二、信息使用方式
   - 所有照片和视频仅存储在您的本地设备
   - 我们不会上传、存储或分享您的照片和视频
   - 所有数据处理均在本地完成
   
   三、信息安全
   - 我们采用业界标准的安全措施保护您的信息
   - 您可以随时在小程序中删除您的数据
   
   四、您的权利
   - 您可以随时在设置中关闭相关权限
   - 您可以随时删除小程序及其所有数据
   
   如有疑问，请联系我们：[您的联系方式]
   ```

4. **选择涉及的接口**
   勾选以下接口：
   - ✅ 相机（camera）
   - ✅ 保存到相册（saveImageToPhotosAlbum）
   - ✅ 录音（record）

5. **提交审核**
   - 填写完成后点击"提交审核"
   - 等待微信官方审核（通常1-3个工作日）

### 测试步骤

1. **清除小程序缓存**
   ```
   在微信中删除小程序 → 重新扫码进入
   ```

2. **测试隐私弹窗**
   - 首次进入相机页面应该显示隐私弹窗
   - 点击"同意"后应该能正常使用相机
   - 点击"拒绝"后应该返回上一页

3. **测试相机功能**
   - 拍照功能
   - 实况拍摄功能
   - 保存到相册功能

## 版本要求

- **微信基础库版本**: 2.32.3 及以上
- **建议在 app.json 中设置**:
  ```json
  {
    "lazyCodeLoading": "requiredComponents",
    "requiredBackgroundModes": [],
    "requiredPrivateInfos": [
      "chooseAddress",
      "chooseInvoiceTitle", 
      "getLocation",
      "onLocationChange",
      "chooseLocation",
      "choosePoi",
      "startLocationUpdate",
      "startLocationUpdateBackground",
      "chooseImage",
      "chooseMedia",
      "chooseVideo",
      "chooseMessageFile",
      "getRecorderManager",
      "saveImageToPhotosAlbum",
      "saveVideoToPhotosAlbum",
      "camera"
    ]
  }
  ```

## 常见问题

### Q1: 开发工具中看不到隐私弹窗？
**A**: 这是正常的，开发工具不会触发隐私弹窗。请在真机预览或体验版中测试。

### Q2: 配置了隐私协议但还是报错？
**A**: 
1. 确认隐私协议已通过审核
2. 确认代码已正确集成隐私弹窗组件
3. 清除小程序缓存后重试
4. 检查基础库版本是否 ≥ 2.32.3

### Q3: 用户拒绝隐私协议后如何再次显示？
**A**: 用户拒绝后，下次进入小程序会重新显示隐私弹窗。

### Q4: 隐私协议审核不通过？
**A**: 
1. 确保内容真实、完整
2. 明确说明收集哪些信息、如何使用
3. 提供有效的联系方式
4. 符合《个人信息保护法》要求

## 相关文档

- [微信小程序隐私保护指引](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/)
- [隐私接口检测工具](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/PrivacyAuthorize.html)
- [个人信息保护法](http://www.npc.gov.cn/npc/c30834/202108/a8c4e3672c74491a80b53a172bb753fe.shtml)

## 更新日志

**2025-11-28**
- ✅ 创建隐私弹窗组件
- ✅ 更新 app.js 添加隐私检查
- ✅ 更新相机页面集成隐私弹窗
- ⏳ 待完成：微信公众平台配置隐私协议

---

**重要提醒**: 
1. 必须在微信公众平台配置并通过审核后，体验版和正式版才能正常使用相机功能
2. 建议先在开发版测试功能正常后，再提交体验版
3. 提交正式版前，务必确保隐私协议已通过审核