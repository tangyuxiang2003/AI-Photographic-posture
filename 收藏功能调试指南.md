# 收藏功能调试指南

## 问题现象
- 控制台显示：`[photos] 从后端加载收藏列表，数量: 0`
- Network 能看到后端返回了图片 URL
- 点击收藏时后端有数据插入
- 但收藏页面不显示图片

## 调试步骤

### 1. 检查后端响应格式

在小程序控制台查看以下日志：

```
[photos] 后端响应: { ... }
```

**预期格式**：
```json
{
  "code": 0,
  "data": [
    {
      "id": 123,
      "aiImageId": 123,
      "aiImageUrl": "http://...",
      "title": "AI生成图",
      "collectTime": "2025-11-07T02:00:00.000Z"
    }
  ],
  "msg": "成功"
}
```

**常见问题**：
- ❌ `data` 字段不是数组
- ❌ `code` 不是 0 或 200
- ❌ 响应是字符串而不是对象

### 2. 检查数据字段映射

查看日志：
```
[photos] 第一条数据示例: { ... }
[photos] 规范化数据: { 原始: {...}, 规范化: {...} }
```

**关键字段检查**：
| 后端字段 | 是否存在 | 值示例 |
|---------|---------|--------|
| `aiImageId` 或 `id` | ✓ | 123 |
| `aiImageUrl` 或 `imageUrl` | ✓ | "http://..." |
| `collectTime` | ? | "2025-11-07..." |

**如果字段名不匹配**，需要修改 `photos/index.js` 中的字段映射。

### 3. 检查 userId 传递

查看日志：
```
[request] 完整请求信息: { url: "...", data: { userId: "..." } }
```

**确认**：
- ✓ `userId` 存在且不为空
- ✓ `userId` 是字符串类型
- ✓ 与后端插入数据时的 `userId` 一致

### 4. 检查收藏接口返回

**测试步骤**：
1. 打开小程序开发者工具
2. 进入 Network 标签
3. 访问收藏页面
4. 找到 `/api/collection/list` 请求
5. 查看 Response

**预期响应**：
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "userId": "123",
      "aiImageId": 456,
      "aiImageUrl": "http://example.com/image.jpg",
      "collectTime": "2025-11-07T02:00:00.000Z"
    }
  ],
  "msg": "成功"
}
```

### 5. 常见问题排查

#### 问题 A：后端返回空数组
**可能原因**：
- userId 不匹配
- 数据库中没有该用户的收藏记录
- 后端查询条件错误

**解决方法**：
1. 检查后端日志，确认收到的 `userId`
2. 直接查询数据库，确认是否有数据
3. 检查后端 SQL 查询条件

#### 问题 B：字段名不匹配
**症状**：
```
[photos] 规范化数据: { 原始: {...}, 规范化: { id: undefined, cover: undefined } }
```

**解决方法**：
修改 `miniprogram/pages/photos/index.js` 第 260-268 行的字段映射：

```javascript
const item = {
  id: x.你的字段名 || x.id,  // 修改这里
  cover: x.你的图片字段 || x.imageUrl,  // 修改这里
  collectTime: x.你的时间字段 || new Date().toISOString()  // 修改这里
};
```

#### 问题 C：数据格式错误
**症状**：
```
[photos] 后端响应: "字符串格式的JSON"
```

**解决方法**：
代码已经处理了字符串解析，但如果仍有问题，检查后端是否正确设置了 `Content-Type: application/json`

### 6. 完整调试日志示例

**正常情况**：
```
[request] 完整请求信息: { url: "http://192.168.43.179:8080/api/collection/list?userId=123", ... }
[request] 响应: { url: "...", status: 200, data: { code: 0, data: [...], msg: "成功" } }
[photos] 后端响应: { code: 0, data: [{ id: 1, aiImageId: 456, aiImageUrl: "http://...", ... }], msg: "成功" }
[photos] 从后端加载收藏列表，数量: 1
[photos] 第一条数据示例: { id: 1, aiImageId: 456, aiImageUrl: "http://...", ... }
[photos] 规范化数据: { 原始: {...}, 规范化: { id: 456, cover: "http://...", ... } }
[photos] 规范化后数量: 1
```

**异常情况**：
```
[photos] 后端响应: { code: 0, data: [], msg: "成功" }
[photos] 从后端加载收藏列表，数量: 0
```

## 快速修复建议

### 方案 1：检查后端返回的字段名
在控制台运行以下代码查看实际字段：
```javascript
// 在收藏页面的 onShow 方法中临时添加
const { get } = require('../../utils/request');
const { getAuth } = require('../../utils/storage');
const auth = getAuth();
get('/api/collection/list', { userId: auth.userId }).then(res => {
  console.log('完整响应:', JSON.stringify(res.data, null, 2));
});
```

### 方案 2：修改字段映射
根据实际后端返回的字段名，修改 `photos/index.js` 中的映射逻辑。

### 方案 3：检查后端接口
确保后端 `/api/collection/list` 接口：
1. 正确接收 `userId` 参数
2. 返回该用户的所有收藏记录
3. 返回格式符合约定

## 需要提供的信息

如果问题仍未解决，请提供以下信息：

1. **完整的控制台日志**（从进入收藏页面开始）
2. **Network 中的完整响应**（`/api/collection/list` 的 Response）
3. **后端数据库中的实际数据**（截图或 SQL 查询结果）
4. **收藏时的请求日志**（`/api/collection/add` 的请求和响应）

这样可以更准确地定位问题所在。