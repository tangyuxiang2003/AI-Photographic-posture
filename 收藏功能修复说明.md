# 收藏功能修复说明

## 问题描述
点击收藏生成的图片后，在收藏列表没有显示已收藏的图片。

## 根本原因
在 `miniprogram/pages/analyze/index.js` 的 `onToggleFavorite` 方法中，保存到本地存储的收藏对象**缺少 `collectTime` 字段**，而收藏列表页面 (`miniprogram/pages/photos/index.js`) 在加载和排序收藏列表时依赖 `collectTime` 字段。

## 修复内容

### 1. 修复 analyze/index.js 中的收藏保存逻辑
**文件**: `miniprogram/pages/analyze/index.js`

**修改位置**: 第 342-350 行和第 359-367 行

**修改前**:
```javascript
const objList = list.map(u => ({ 
  id: this.data.aiIdMap[u], 
  title: 'AI生成图', 
  cover: u, 
  tags: [], 
  type: 'AI' 
}));
```

**修改后**:
```javascript
const objList = list.map(u => ({ 
  id: this.data.aiIdMap[u], 
  title: 'AI生成图', 
  cover: u, 
  tags: [], 
  type: 'AI',
  collectTime: new Date().toISOString()  // 新增收藏时间字段
}));
```

### 2. 修复 sync.js 中的字段映射
**文件**: `miniprogram/utils/sync.js`

**修改位置**: 第 43-50 行

**修改前**:
```javascript
const favorites = items.map(item => ({
  id: item.aiImageId || item.id,
  title: item.title || 'AI生成图',
  cover: item.aiImageUrl || item.imageUrl || item.cover,
  tags: item.tags || [],
  type: item.type || 'AI',
  createdAt: item.createdAt || item.createTime  // 使用了错误的字段名
}))
```

**修改后**:
```javascript
const favorites = items.map(item => ({
  id: item.aiImageId || item.id,
  title: item.title || 'AI生成图',
  cover: item.aiImageUrl || item.imageUrl || item.cover,
  tags: item.tags || [],
  type: item.type || 'AI',
  collectTime: item.collectTime || item.createdAt || item.createTime || new Date().toISOString()  // 统一使用 collectTime
}))
```

## 验证步骤

1. **清除旧数据**（可选，建议清除以确保测试准确）:
   - 在小程序中进入"个人中心"
   - 点击"清理缓存"按钮
   - 重新登录

2. **测试收藏功能**:
   - 进入"分析"页面，生成一些 AI 图片
   - 点击图片上的收藏按钮（星形图标）
   - 确认显示"已收藏"提示

3. **验证收藏列表**:
   - 进入"我的收藏"页面（从首页点击"我的收藏"）
   - 确认刚才收藏的图片显示在列表中
   - 确认图片按收藏时间倒序排列（最新收藏的在最上方）

4. **测试取消收藏**:
   - 在收藏列表中点击图片的收藏按钮
   - 确认显示"已取消收藏"提示
   - 确认图片从列表中移除

## 技术细节

### 数据流程
1. **收藏操作** (`analyze/index.js`):
   - 用户点击收藏按钮
   - 调用后端 API: `POST /api/collection/add`
   - 同时更新本地存储: `app_favorites`（包含 `collectTime` 字段）

2. **加载收藏列表** (`photos/index.js`):
   - 从后端获取: `GET /api/collection/list`
   - 规范化数据格式（确保包含 `collectTime`）
   - 按 `collectTime` 倒序排序
   - 显示在页面上

3. **数据同步** (`utils/sync.js`):
   - 登录后自动同步后端收藏数据
   - 将后端字段映射为本地格式（`collectTime`）
   - 保存到本地存储

### 字段映射关系
| 后端字段 | 本地字段 | 说明 |
|---------|---------|------|
| `aiImageId` | `id` | 图片唯一标识 |
| `aiImageUrl` | `cover` | 图片URL |
| `collectTime` / `createdAt` | `collectTime` | 收藏时间（ISO格式） |
| `title` | `title` | 图片标题 |
| `tags` | `tags` | 标签数组 |
| `type` | `type` | 类型（默认'AI'） |

## 注意事项
- 修复后，新收藏的图片会正确显示在收藏列表中
- 旧的收藏数据（修复前收藏的）可能缺少 `collectTime` 字段，会使用当前时间作为默认值
- 建议用户清除缓存后重新收藏，以确保数据完整性