<view class="analyze-wrap">
  <!-- 生成中：仅显示进度卡片 -->
  <view wx:if="{{!done && !failed}}" class="progress-wrap">
    <view class="star-square">
      <view class="stars stars-1"></view>
      <view class="stars stars-2"></view>

      <view class="progress-text">生成中 {{progress}}%</view>
      <view class="progress-subtext">你的专属姿势即将完成！</view>
    </view>
  </view>

  <!-- 完成：一次性展示所有返回图片 -->
  <view wx:if="{{done}}" class="grid">
    <block wx:for="{{images}}" wx:key="*this">
      <view class="grid-item-wrap fade-in">
        <image class="grid-item" mode="aspectFill" src="{{item}}" bindtap="onPreview" data-url="{{item}}" />
        <view class="fav-btn {{favMap[item] ? 'fav--active' : ''}}" catchtap="onToggleFavorite" data-url="{{item}}"></view>
      </view>
    </block>
  </view>

  <!-- 生成完成反馈 -->
  <view wx:if="{{done && feedbackText}}" class="feedback-bubble">{{feedbackText}}</view>

  <!-- 常驻：继续优化区域（不弹窗） -->
  <view class="refine-card">
    <view class="refine-title">继续优化</view>
    <textarea class="refine-textarea"
              placeholder="描述你期望的姿势、风格、情绪等（可选）"
              bindinput="onRefinedPromptInput"
              value="{{refinedPrompt}}"
              auto-height
              maxlength="300" />
    <view class="refine-actions">
      <button class="refine-btn {{(!done || refining) ? 'refine-btn--disabled' : ''}}"
              bindtap="onGenerateWithRefinedPrompt"
              disabled="{{!done || refining}}">
        继续优化
      </button>
    </view>
  </view>

  <!-- 失败兜底 -->
  <view wx:if="{{failed}}" class="empty">生成失败，请重试</view>
</view>