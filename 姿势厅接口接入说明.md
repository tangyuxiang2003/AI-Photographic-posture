# 姿势厅接口接入说明

## ✅ 已完成的接口接入

### 1. 姿势分组列表接口

**接口信息：**
- **地址**: `/api/reference-image/list/group-by-tag`
- **方法**: GET
- **认证**: Bearer Token（自动从 storage 获取）
- **参数**: 无

**返回数据结构：**
```json
{
  "code": 200,
  "msg": "成功",
  "data": {
    "咖啡厅": [
      {
        "id": 12,
        "tag": "咖啡厅",
        "url": "https://...",
        "createTime": "2025-11-12T07:22:57.000+00:00"
      },
      {
        "id": 13,
        "tag": "闺蜜照",
        "url": "https://...",
        "createTime": "2025-11-12T07:23:02.000+00:00"
      }
    ]
  }
}
```

**使用位置：**
- `miniprogram/pages/gallery/index.js` - 姿势厅主页
- `miniprogram/pages/category-detail/category-detail.js` - 分类详情页

## 📝 代码修改说明

### 1. 姿势厅主页 (gallery/index)

**主要改动：**
```javascript
// 引入请求工具
const { get } = require('../../utils/request')

// 数据结构调整
data: {
  poseGroups: []  // 从固定的 localPoses, beautyPoses 改为动态的 poseGroups
}

// 接口调用
async loadPoses() {
  const res = await get('/api/reference-image/list/group-by-tag')
  // 解析数据并只取每组前2张图片
  const poseGroups = groups.map(group => ({
    tag: group.tag,
    poses: (group.poses || []).slice(0, 2)
  }))
}
```

**WXML 改动：**
- 使用 `wx:for="{{poseGroups}}"` 动态渲染分组
- 图片地址从 `item.image` 改为 `pose.url`
- 传递参数从 `category` 改为 `tag`

### 2. 分类详情页 (category-detail)

**主要改动：**
```javascript
// 接收参数改为 tag
onLoad(options) {
  const tag = decodeURIComponent(options.tag || '')
}

// 从接口数据中筛选对应标签的姿势
const targetGroup = groups.find(g => g.tag === this.data.tag)
```

### 3. 姿势详情页 (pose-detail)

**主要改动：**
```javascript
// 接收 URL 参数
onLoad(options) {
  const poseUrl = decodeURIComponent(options.url || '')
  this.setData({ 
    pose: {
      id: poseId,
      url: poseUrl  // 使用传递的 URL
    }
  })
}
```

## 🔄 数据流转

```
用户打开姿势厅
    ↓
调用 /api/reference-image/list/group-by-tag
    ↓
获取所有分组数据
    ↓
每个分组只显示前2张图片
    ↓
点击"全部 >" → 跳转到分类详情页（传递 tag）
    ↓
分类详情页再次调用接口，筛选该 tag 的所有姿势
    ↓
点击姿势 → 跳转到详情页（传递 id 和 url）
```

## 🛡️ 错误处理

### 1. 接口调用失败
- 显示 loading 提示
- 捕获错误并显示 toast
- 降级到模拟数据（可选）

### 2. Token 失效
- `request.js` 自动处理 401/403
- 清除本地 token
- 可引导用户重新登录

### 3. 数据为空
- 显示"暂无姿势数据"空状态

## 📊 接口响应处理

```javascript
// 统一处理响应数据
const responseData = typeof res.data === 'string' 
  ? JSON.parse(res.data) 
  : res.data

if (responseData.code === 200 && responseData.data) {
  // 处理成功数据
} else {
  throw new Error(responseData.msg || '数据格式错误')
}
```

## 🔐 认证机制

所有接口请求自动携带 Token：
- 从 `storage.js` 的 `getAuth()` 获取 token
- 在请求头中添加 `Authorization: Bearer ${token}`
- 由 `request.js` 统一处理

## 📱 页面展示

### 姿势厅主页
- 动态渲染所有标签分组
- 每个分组显示 2 张图片（一行）
- 支持点击查看更多

### 分类详情页
- 网格布局显示该标签的所有姿势
- 每行 2 张图片
- 支持滚动加载

### 姿势详情页
- 全屏展示姿势图片
- 显示姿势信息
- 提供"使用"按钮

## 🚀 后续优化建议

1. **分页加载**
   - 当姿势数量较多时，实现分页或懒加载
   
2. **缓存机制**
   - 缓存接口数据，减少重复请求
   
3. **搜索功能**
   - 接入搜索接口（如果后端提供）
   
4. **标签筛选**
   - 实现标签点击筛选功能
   
5. **图片预加载**
   - 预加载图片提升用户体验

## 📋 测试清单

- [x] 姿势厅主页正常加载数据
- [x] 每个分组显示 2 张图片
- [x] 点击"全部 >"跳转到分类详情
- [x] 分类详情页显示该标签所有姿势
- [x] 点击姿势跳转到详情页
- [x] 详情页正确显示图片
- [x] 接口失败时的错误处理
- [x] Token 自动携带
- [ ] 未登录时点击"使用"的提示
- [ ] 登录后点击"使用"的跳转

---

**更新时间**: 2025-11-12
**状态**: ✅ 接口接入完成